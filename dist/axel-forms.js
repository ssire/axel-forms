/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2012 S. Sire
 *
 * This file contains files from the AXEL-FORMS extension to the Adaptable XML Editing Library (AXEL)
 * Version 0.3
 *
 * AXEL-FORMS is licensed by Oppidoc SARL 
 *
 * Web site : http://www.oppidoc.fr, https://bitbucket.org/ssire/axel-forms
 * 
 * Contributors(s) : S. Sire
 * 
 * ***** END LICENSE BLOCK ***** */
 (function(h){var i=0,k=0;var a={};var e={};var c={};var l={defaults:{},configure:function(m,n){this.defaults[m]=n},logError:function(n,m){h.error(n,m)},register:function(o,n,p){var m={factory:n};if(p){h.extend(m,p)}a[o]=m},getEditor:function(m){return e[m]},getCommand:function(n,o){var m=n,p=o,r=c[o],q=r?r[n]:undefined;return q||{execute:function(){alert("Command "+m+" not found on "+p)}}}};function b(m,n){xtiger.cross.log("debug","adding editor "+m);e[m]=n}function j(o,p){var n=$(o).attr("id")||("untitled"+(i++)),m=new a.transform.factory(n,o,p);xtiger.cross.log("debug","registering editor "+n);e[n]=m;return m}function f(q,p,r){var o=$(q).attr("data-target")||("untitled"+(k++)),s=$(q).attr("id"),n=a[p],m;if(n){if(n.check){if(h.command.getEditor(o)){if(q.disabled){q.disabled=false}m=new a[p].factory(o,q,r)}else{q.disabled=true;h.error("Missing or invalid data-target attribute in "+p+' command ("'+o+'")')}}else{m=new a[p].factory(o,q,r)}if(m&&s){if(!c[s]){c[s]={}}c[s][p]=m}}else{h.error('Attempt to create an unkown command "'+p+'"')}}function d(t,u,p){var o,w,n,m=u||t,r=p||u,v=[],s=[],q=[];n=u?"[data-template]":"* [data-template]";w=m;do{$(n,w).each(function(x,y){v.push(y)});w=u?w.nextSibling:undefined}while(w&&(w!==p)&&(r!=u));n="[data-command]";w=m;do{$(n,w).each(function(x,z){var y=$(z).attr("data-command");if(/\btransform\b/.test(y)){if(!$(z).attr("data-template")){v.push(z)}}if(!/^\s*\btransform\b\s*$/.test(y)){s.push(z)}});w=u?w.nextSibling:undefined}while(w&&(w!==p)&&(r!=u));if(l.defaults.bundlesPath){for(o=0;o<v.length;o++){q.push(j(v[o],t))}}else{if(v.length>0){h.error("Cannot start editing because AXEL bundles path is unspecified")}}for(o=0;o<s.length;o++){v=$(s[o]).attr("data-command").split(" ");for(w=0;w<v.length;w++){if(v[w]!=="transform"){f(s[o],v[w],t)}}}return q}h.command=l;h.command.install=d;h.command.addEditor=b;h.resolveUrl=function g(m,p){var o=m,n;if(m&&(m.length>2)){if(m.charAt(0)==="~"&&m.charAt(1)==="/"){if((window.location.href.charAt(window.location.href.length-1))!=="/"){o=window.location.href.split("#")[0]+"/"+m.substr(2)}else{o=m.substr(2)}}else{if(m.charAt(0)==="^"&&m.charAt(1)==="/"){o=($(p).closest("*[data-axel-base]").attr("data-axel-base")||"/")+m.substr(2)}}if(o.indexOf("$^")!==-1){n=window.location.href.split("#")[0].match(/([^\/]+)\/?$/);if(n){o=o.replace("$^",n[1])}}}return o};jQuery(function(){var n=$("script[data-bundles-path]"),o=n.attr("data-bundles-path"),m=n.attr("data-when"),p;if(o){l.configure("bundlesPath",o);h.filter.applyTo({optional:["input","choice"],event:"input"})}if(navigator.browserLanguage){p=navigator.browserLanguage}else{p=navigator.language}if(p){p=p.substr(0,2);if(xtiger.defaults.locales[p]){h.setLocale(p);xtiger.cross.log("debug","set lang to "+p)}}if("deferred"!==m){d(document)}})}($axel));(function(h){var a={};var j={getDocument:function(){return this._doc},getParam:function(k){return this._param[k]||this._defaults[k]},getVariable:function(){return this._variable}};var c={_installError:function(k){this.errScope=k.attr("data-error-scope")||undefined;this.errSel="[data-"+this.getName()+'-error="'+this.getVariable()+'"]'},toggleError:function(n,l){var k,m,o=this.getDocument();if(!this.errScope){k=$("body "+this.errSel,o)}else{if(l){m=$(l,o).closest(this.errScope);k=$(this.errSel,m.get(0))}}if(k){if(n){k.hide()}else{k.show()}}return n}};function d(n,m,l){var k=new Function();k.prototype=(function(o){var p=o;return{getName:function(){return p}}}(n));h.extend(k.prototype,j);if(m&&m.error){h.extend(k.prototype,c)}k.prototype.onInstall=l.onInstall;h.extend(k.prototype,l.methods,false,true);return k}function g(q,o,t,s,p){var r,l,u,m=s||".af-label",n=[],k=[];q.apply(function(C){if(p&&$(C.getHandle(true)).closest(p).size()>0){return}var v=(C.getParam("required")==="true"),x=C.isValid,w=(C.getParam("required")!=="true")||C.isModified(),A=(!w)||(!C.isValid||C.isValid()),B=$(C.getHandle()),y=B.parents().children(m).first(),D,z;if(w&&v){B.removeClass("af-required");y.removeClass("af-required")}if(A&&x){B.removeClass("af-invalid");y.removeClass("af-invalid")}if((v||x)&&(!w||!A)){D=y.contents(":not(span)").text();z=D.lastIndexOf(":");if(z!=-1){D=D.substr(0,z)}D=$.trim(D);if(!w&&v){B.addClass("af-required");y.addClass("af-required");n.push(D)}else{if(x){B.addClass("af-invalid");y.addClass("af-invalid");k.push(D)}}}});if(o){l=$("#"+o,t).html("");if(n.length>0){l.append("<p>"+xtiger.util.getLocaleString("errFormRequired",{fields:n.join(", ")})+"</p>")}if(k.length>0){l.append("<p>"+xtiger.util.getLocaleString("errFormInvalid",{fields:k.join(", ")})+"</p>")}r=(n.length===0)&&(k.length===0);if(!r){l.addClass("af-validation-failed");u=$.Event("axel-validate-error",{required:n.length,invalid:k.length});l.triggerHandler(u)}else{l.removeClass("af-validation-failed")}}return r}function b(l,k){if(l){if(typeof l.isValid==="function"){l.isValid.extend(k)}else{l.isValid=function(n){var o=[n];var m=function(){var q,p=true;for(var q=0;q<o.length;q++){p=p&&o[q](this)}return p};m.extend=function(p){o.push(p)};return m}(k)}}else{xtiger.cross.log("error","attempt to set a validator function on an undefined editor")}}function i(n,m,o,q){var p={},l=d(n,m,q);h.extend(p,o);a[n]={name:n,options:m,defaults:p,klass:l}}function e(t,u,q){var n,o,m,s,l={},p=true;var r=u.attr("data-variable");if(r){m=t.defaults;for(n in m){if(m.hasOwnProperty(n)){s=u.attr("data-"+n);if(s){l[n]=s}else{if(m[n]===h.binding.REQUIRED){xtiger.cross.log("error",'Missing attribute "data-'+n+'" to install "'+t.name+'" binding');p=false;break}}}}if(p){o=new t.klass();o._doc=q;o._variable=r;o._defaults=m;o._param=l;if(t.options&&t.options.error){o._installError(u)}o.onInstall(u);return o}}else{xtiger.cross.log("error",'Missing attribute "data-variable" to install "'+t.name+'" binding')}}function f(o,k,n){var p=k||o,l=n||k,m=k?"[data-binding]":"body [data-binding]";do{$(m,p).each(function(q,u){var r,s=$(u),t=s.attr("data-binding").split(" ");for(r=0;r<t.length;r++){if(a[t[r]]){e(a[t[r]],s,o)}else{xtiger.cross.log("error",'unregistered binding "'+t[r]+'"')}}});p=k?p.nextSibling:undefined}while(p&&(p!==n)&&(l!=k))}h.binding=h.binding||{};h.binding.list=function(){var k,l=[];for(k in a){l.push(k)}return l};h.binding.register=i;h.binding.install=f;h.binding.validate=g;h.binding.setValidation=b;h.binding.REQUIRED=1}($axel));(function(a){var b={getCommand:function(h){var g,i,c,d={xhr:h};if(h.responseXML){d.doc=h.responseXML}else{c=h.getResponseHeader("Content-Type");if(a.oppidum.checkJSON(c)){try{d.json=JSON.parse(h.responseText)}catch(f){}}else{i=xtiger.cross.makeDOMParser();try{d.doc=i.parseFromString(h.responseText,"text/xml")}catch(f){}}}return d},filterRedirection:function(d){var e=d.xhr&&d.xhr.getResponseHeader("Location"),c=true;if(e){window.location.href=e;c=false}return c},decodeMessage:function(c){var d;if(c.doc){d=$("success > message",c.doc).text()}else{if(c.json){d=c.json.message?c.json.message["#text"]:'missing "message" element in response'}else{d=xhr.responseText}}return d},handleMessage:function(c){var d=a.oppidum.decodeMessage(c);if(d){alert(d)}},handleForward:function(e){var g,f,d,c;if(e.doc){d=$("success > forward",e.doc);g=d.attr("command");f=d.text()}if(g&&f){c={synthetic:true,command:e};a.command.getCommand(g,f).execute(c)}},checkJSON:function(d){var c="application/json";return(typeof d==="string")&&(d.slice(0,c.length)===c)},unmarshalMessage:function(d){var c=d.responseXML?$("success > message",d.responseXML).text():d.responseText;return c},unmarshalPayload:function(e){var f=e.responseText.indexOf("<payload>"),c,d=e.responseText;if(-1!==f){c=e.responseText.indexOf("</payload>");if(-1!==c){d=e.responseText.substr(f+9,c-f-9)}}return d},isResponseAnOppidumError:function(g){var d=g.getResponseHeader("Content-Type"),c=false;if(g.responseXML){c=$("error > message",g.responseXML).size()>0}else{if(a.oppidum.checkJSON(d)){try{c=JSON.parse(g.responseText).message!==undefined}catch(f){}}}return c},getOppidumErrorMsg:function(g){var d=g.getResponseHeader("Content-Type"),c;if(g.responseXML){c=$("error > message",g.responseXML).text()}else{if(a.oppidum.checkJSON(d)){try{c=JSON.parse(g.responseText).message["#text"]}catch(f){}}else{c=g.responseText}}return c||g.status},getExistErrorMsg:function(h){var g=h.responseText,d=h.status;var f="Error ! Result code : "+d;var e="";var c=g.match("<title>(.*)</title>","m");if(c){e="\n"+c[1]}c=g.match("<h2>(.*)</h2>","m");if(c){e=e+"\n"+c[1]}else{if($("div.message",h.responseXML).size()>0){e=e+"\n"+$("div.message",h.responseXML).get(0).textContent;if($("div.description",h.responseXML).size()>0){e=e+"\n"+$("div.description",h.responseXML).get(0).textContent}}}return f+e},parseError:function(i,c,f,d){var h,g;if(c==="timeout"){g=xtiger.util.getLocaleString("errServerTimeOut")}else{if(i.status===409){h=i.getResponseHeader("Location");if(h){window.location.href=h;g=xtiger.util.getLocaleString("msgRedirect")}else{g=a.oppidum.getOppidumErrorMsg(i)}}else{if(a.oppidum.isResponseAnOppidumError(i)){g=a.oppidum.getOppidumErrorMsg(i)}else{if(i.responseText.search("Error</title>")!==-1){g=a.oppidum.getExistErrorMsg(i)}else{if(f&&(typeof f==="string")){g=xtiger.util.getLocaleString("errException",{e:{message:f},status:i.status})}else{if(f){g=xtiger.util.getLocaleString("errException",{e:f,status:i.status})}else{if(d){g=xtiger.util.getLocaleString("errLoadDocumentStatus",{url:d,xhr:i})}else{if(i.responseText!==""){g=i.responseText}else{g=xtiger.util.getLocaleString("errLoadDocumentStatus",{xhr:i})}}}}}}}}return g}};xtiger.registry.registerFactory("protocol.upload",{getInstance:function(c){return{decode_success:function(e){var d=e.getResponseHeader("Location");if(d){window.location.href=d}return(-1!==e.responseText.indexOf("<payload"))?a.oppidum.unmarshalPayload(e):a.oppidum.unmarshalMessage(e)},decode_error:function(d){return a.oppidum.parseError(d,d.status)}}}});a.oppidum=b}($axel));(function(a){var b=(function(){function f(h){var g;if(h.indexOf("\\ ")===-1){return h.split(" ")}else{g=h.replace(/\\ /g,"&nbsp;");return xtiger.util.array_map(g.split(" "),function(i){return i.replace(/&nbsp;/g," ")})}}function c(n,p){var j,h,s,m=n.getHandle(),r=n.getDocument(),q=n.getParam("multiple")==="yes"?"checkbox":"radio",k=n.getParam("noedit")==="true"?'disabled="true" ':"",g=n.getUniqueKey(),l=n.getParam("appearance")==="full";$("*",m).remove(":not(.axel-choice-placeholder)");if(p&&(p.length>0)){for(j=0;j<p.length;j++){if(l){$(m).append("<li><label><input "+k+'type="'+q+'" value="'+p[j].value+'" name ="'+g+'"/>'+p[j].label+"</label></li>")}else{h=xtdom.createElement(r,"option");s=xtdom.createTextNode(r,p[j].label);xtdom.setAttribute(h,"value",p[j].value);if(n.getParam("noedit")==="true"){xtdom.setAttribute(h,"disabled",true)}h.appendChild(s);m.appendChild(h)}}$(m).prop("disabled",false)}else{$(m).prop("disabled",true)}}function d(p,s,l){var j,h,u,n=p.getHandle(),r=p.getDocument(),q=p.getParam("multiple")==="yes"?"checkbox":"radio",k=p.getParam("noedit")==="true"?'disabled="true" ':"",g=p.getUniqueKey(),m=p.getParam("appearance")==="full";if(s&&(s.length>0)){for(j=0;j<s.length;j++){if(m){$(n).append("<li><label><input "+k+'type="'+q+'" value="'+s[j]+'" name ="'+g+'"/>'+l[j]+"</label></li>")}else{h=xtdom.createElement(r,"option");u=xtdom.createTextNode(r,l[j]);xtdom.setAttribute(h,"value",s[j]);if(p.getParam("noedit")==="true"){xtdom.setAttribute(h,"disabled",true)}h.appendChild(u);n.appendChild(h)}}}else{$(n).prop("disabled",true)}}function e(g,h){var i=true;if(!g){if(typeof h==="string"){i=h!==g}else{if(!h||((h.length===1)&&!h[0])){i=false}}}else{i=h!==g}return i}return{onGenerate:function(j,i,g){var h;if(this.getParam("appearance")==="full"){h=xtdom.createElement(g,"ul")}else{h=xtdom.createElement(g,"select")}xtdom.addClassName(h,"axel-choice");j.appendChild(h);return h},onInit:function(j,h,i){var g=this.getParam("values");if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}if(this.getParam("multiple")==="yes"){$(this._handle).attr("multiple","multiple")}if(!i){d(this,this.getParam("values"),this.getParam("i18n"))}},onAwake:function(){var j=this,g=this.getDefaultData(),h=this.getParam("placeholder"),i=$(this._handle);if((this.getParam("appearance")!=="full")&&(h||(!g))){h=h||"";if(i.find(".axel-choice-placeholder").length===0){i.prepend('<option class="axel-choice-placeholder" selected="selected" value="">'+(h||"")+"</option>")}if(!g){this._param.values.splice(0,0,h);if(this._param.i18n!==this._param.values){this._param.i18n.splice(0,0,h)}if(h){i.addClass("axel-choice-placeholder")}}}xtdom.addEventListener(this._handle,"change",function(k,l){if(!(l&&l.synthetic)){if(j.getParam("appearance")==="full"){var m=[];$("input",j.getHandle()).each(function(n,o){if(o.checked){m.push($(o).val())}});j.update(m)}else{j.update($(xtdom.getEventTarget(k)).val())}}},true);this._setData(g)},onLoad:function(m,l){var k,h,j,g,i;if(l.isEmpty(m)){this.clear(false)}else{g=this.getParam("xvalue");h=this.getDefaultData();if(g){k=[];j=l.getVectorFor(g,m);while(j!==-1){i=l.getDataFor(j);if(i){k.push(i)}j=l.getVectorFor(g,m)}this._setData(k.length>0?k:"")}else{i=l.getDataFor(m);if(typeof i!=="string"){i=""}k=(i||h).split(",");this._setData(k)}this.set(false);this.setModified(e(h,k))}},onSave:function(h){var g,k,j;if((!this.isOptional())||this.isSet()){if(this._data&&(this._data!==this.getParam("placeholder"))){g=this.getParam("xvalue");if(g){if(typeof this._data==="string"){h.openTag(g);h.write(this._data);h.closeTag(g)}else{for(j=0;j<this._data.length;j++){if(this._data[j]!==""){h.openTag(g);h.write(this._data[j]);h.closeTag(g)}}}}else{h.write(this._data.toString().replace(/^,/,""))}}}else{h.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(i){var j,h;this._param={};xtiger.util.decodeParameters(i.getAttribute("param"),this._param);h=xtdom.extractDefaultContentXT(i);j=i.getAttribute("option");this._option=j?j.toLowerCase():null;var g=i.getAttribute("values"),m=i.getAttribute("i18n"),l=g?f(g):[],k=m?f(m):undefined;this._param.values=l;this._param.i18n=k||l;this._content=h||""},isFocusable:function(){return true},focus:function(){}},methods:{ajax:function(g){c(this,g.items);if(g.restore){this._setData(this._data)}else{this.clear(false)}},_setData:function(h,i){var g;if(this.getParam("appearance")!=="full"){if(!h&&(this.getParam("placeholder"))){$(this.getHandle()).addClass("axel-choice-placeholder")}else{$(this.getHandle()).removeClass("axel-choice-placeholder")}}this._data=h||"";if(!i){if(this.getParam("appearance")==="full"){g=typeof this._data==="string"?[this._data]:this._data;$("input",this.getHandle()).each(function(j,k){if($.inArray($(k).val(),g)>-1){k.checked=true;xtdom.removeClassName(k.parentNode,"axel-choice-unset")}else{k.checked=false;xtdom.addClassName(k.parentNode,"axel-choice-unset")}})}else{$(this.getHandle()).val(h)}}},dump:function(){return this._data},update:function(g){var h=e(this.getDefaultData(),g);this.setModified(h);this._setData(g,true);this.set(h)},clear:function(g){this._setData(this.getDefaultData());if(this.isOptional()){this.unset(g)}}}}}());a.plugin.register("choice",{filterable:true,optional:true},{choice:"value"},b);a.filter.applyTo({event:["choice"]})}($axel));(function(a){var b=(function(){function c(i){var h,g=[];for(h in i){if(i[h]){g.push(h+":"+i[h])}}h=g.join(";");return h?' style="'+h+'"':""}function e(j,g){var l,k,i="",o=j.getParam("choice2_width1"),n=c({width:o}),h={left:o,width:j.getParam("choice2_width2")},m;if(j.getParam("choice2_position")==="left"){h["margin-left"]="-"+(parseInt(o)+parseInt(h.width)+2)+"px"}m=c(h);for(l in g){o="";for(k in g[l]){if(k!=="_label"){o+='<li class="choice2-label" data-code="'+k+'">'+g[l][k]+"</li>"}}i+='<li class="choice2-option"><div class="choice2-item"'+n+">"+l+" "+g[l]._label+'</div><ul class="choice2-popup2 choice2-drop-container"'+m+">"+o+"</ul></li>"}i='<ul class="choice2-popup1 choice2-drop-container"'+n+">"+i.replace(/&/g,"&amp;")+"</ul>";$(j.getHandle()).append(i)}function f(g){if(0===g.find("li.choice2-label:not(.selected)").size()){g.addClass("selected")}else{g.removeClass("selected")}}function d(g,h){var i=true;if(!g){if(typeof h==="string"){i=h!==g}else{if(!h||((h.length===1)&&!h[0])){i=false}}}else{i=h!==g}return i}return{onGenerate:function(j,i,g){var h,k={width:this.getParam("choice2_width0")};h=xtdom.createElement(g,"div");xtdom.addClassName(h,"axel-choice2");$(h).html('<div class="select2-container-multi"'+c(k)+'><ul class="select2-choices"></ul></div>');j.appendChild(h);return h},onInit:function(j,h,i){var g=this.getParam("values");if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}if(!i){e(this,this.getParam("values"))}},onAwake:function(){var i=this,g=this.getDefaultData(),h=this.getParam("placeholder");if((this.getParam("appearance")!=="full")&&(h||(!g))){h=h||""}this._setData(g);$(this._handle).children("div.select2-container-multi").click($.proxy(this,"_handleClickOnChoices"));$(this._handle).find("li.choice2-label").click($.proxy(this,"_handleClickOnLabel"));$(this._handle).find("div.choice2-item").click($.proxy(this,"_handleClickOnItem"))},onLoad:function(m,l){var k,h,j,g,i;if(l.isEmpty(m)){this.clear(false)}else{g=this.getParam("xvalue");h=this.getDefaultData();if(g){k=[];j=l.getVectorFor(g,m);while(j!==-1){i=l.getDataFor(j);if(i){k.push(i)}j=l.getVectorFor(g,m)}this._setData(k.length>0?k:"")}else{i=l.getDataFor(m);if(typeof i!=="string"){i=""}k=(i||h).split(",");this._setData(k)}this.set(false);this.setModified(d(h,k))}},onSave:function(h){var g,k,j;if((!this.isOptional())||this.isSet()){if(this._data&&(this._data!==this.getParam("placeholder"))){g=this.getParam("xvalue");if(g){if(typeof this._data==="string"){h.openTag(g);h.write(this._data);h.closeTag(g)}else{for(j=0;j<this._data.length;j++){if(this._data[j]!==""){h.openTag(g);h.write(this._data[j]);h.closeTag(g)}}}}else{h.write(this._data.toString().replace(/^,/,""))}}}else{h.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(i){var j,h;this._param={};xtiger.util.decodeParameters(i.getAttribute("param"),this._param);h=xtdom.extractDefaultContentXT(i);j=i.getAttribute("option");this._option=j?j.toLowerCase():null;var g=i.getAttribute("values"),k=JSON.parse(g);this._param.values=k;this._content=h||""},isFocusable:function(){return true},focus:function(){}},methods:{_handleClickOnChoices:function(k){var i=$(k.target),j=$(k.target).closest(".axel-choice2"),o,m,g,l;if(i.hasClass("select2-choices")||i.hasClass("select2-label")){m=i.hasClass("select2-label")?i.closest(".select2-choices").offset():i.offset();g=i.hasClass("select2-label")?i.closest(".select2-choices").height():i.height();o=j.children("ul.choice2-popup1");if(o.hasClass("show")){$("div.select2-container-multi ul",this._handle).css("minHeight","")}o.toggleClass("show").offset({top:m.top+g+1,left:m.left})}else{if(i.hasClass("select2-search-choice-close")){i=$(k.target).closest("li[data-code]").first();l=i.attr("data-code");o=j.find('ul.choice2-popup1 li.choice2-label[data-code="'+l+'"]').removeClass("selected");this.removeFromSelection(l,o);i.remove();k.stopPropagation()}}},_handleClickOnItem:function(i){var k=$(i.target),h=k.parent().find("li.choice2-label"),g="yes"===this.getParam("multiple"),j=this;if(g||(1===h.size())){if(k.parent().hasClass("selected")){h.each(function(l,m){var o=$(m);j.removeFromSelection(o.attr("data-code"),false);o.removeClass("selected")})}else{if(!g){this.setSelection([])}h.each(function(l,m){var o=$(m);j.addToSelection(o.attr("data-code"),o.text());o.addClass("selected")})}k.parent().toggleClass("selected")}},_handleClickOnLabel:function(g){var h=$(g.target);if(("yes"!==this.getParam("multiple"))&&!h.hasClass("selected")){this.setSelection([])}h.toggleClass("selected");if(h.hasClass("selected")){this.addToSelection(h.attr("data-code"),h.text());f(h.closest(".choice2-option"))}else{this.removeFromSelection(h.attr("data-code"),h)}},setSelection:function(g){var k="",l=$("li.choice2-label",this._handle),j,h;l.filter(".selected").removeClass("selected");for(j=0;j<g.length;j++){if(g[j].length>0){h=l.filter('[data-code="'+g[j]+'"]').first().addClass("selected").text();k+='<li class="select2-search-choice" data-code="'+g[j]+'"><div class="select2-label">'+h.replace(/&/g,"&amp;")+'</div><a class="select2-search-choice-close" tabindex="-1" onclick="return false;" href="#"></a></li>'}}$("div.select2-container-multi > ul",this._handle).html(k);$("li.choice2-option",this._handle).each(function(m,n){f($(n))})},addToSelection:function(i,g){var h=$("div.select2-container-multi > ul",this._handle);if((h.find('li.select2-search-choice[data-code="'+i+'"]')).size()===0){h.append('<li class="select2-search-choice" data-code="'+i+'"><div class="select2-label">'+g.replace(/&/g,"&amp;")+'</div><a class="select2-search-choice-close" tabindex="-1" onclick="return false;" href="#"></a></li>');if("true"===this.getParam("choice2_closeOnSelect")){$("ul.choice2-popup1",this._handle).removeClass("show")}this.update($("li.select2-search-choice",this._handle).map(function(j,k){return $(k).attr("data-code")}).get())}},removeFromSelection:function(g,h){var i=$("div.select2-container-multi ul",this._handle);if($(this._handle).children("ul.choice2-popup1").hasClass("show")){i.css("minHeight",i.height()+"px")}$('div.select2-container-multi li[data-code="'+g+'"]',this._handle).remove();this.update($("li.select2-search-choice",this._handle).map(function(j,k){return $(k).attr("data-code")}).get());if(h){h.closest(".choice2-option").removeClass("selected")}},_setData:function(h,i){var g;this._data=h||"";if(!i){g=typeof this._data==="string"?[this._data]:this._data;this.setSelection(g)}},dump:function(){return this._data},update:function(g){var h=d(this.getDefaultData(),g);this.setModified(h);this._setData(g,true);this.set(h)},clear:function(g){this._setData(this.getDefaultData());if(this.isOptional()){this.unset(g)}}}}}());a.plugin.register("choice2",{filterable:true,optional:true},{},b);a.filter.applyTo({event:["choice2"]})}($axel));(function(m){var n={};var a={};var j=function j(p,q){if(p){if(!n[p]){n[p]={}}n[p][q]=true}};var b=function b(p,r){var q=false;if(p){if(n[p]&&n[p][r]){delete n[p][r];q=true}}return q};var l=function(p){var q=p.getParam("date_format");return xtiger.util.date.convertDate(p,$.datepicker.formatDate($.datepicker[q]||q,new Date()),"date_format","date_region")};var d=function(r,q){var s=parseInt(q),p=((s===0)||(isNaN(s)))?1:s;if(a[r]===undefined){a[r]=0}else{a[r]+=1}return Math.floor(a[r]/p)};var c=function(p,q){var r;if(p.length>1){q.openTag("Block");while(r=p.shift()){q.openTag("Line");q.write(r);q.closeTag("Line")}q.closeTag("Block")}else{if(1===p.length){q.openTag("Text");q.write(p.pop());q.closeTag("Text")}}};var i=function(q){var r=q.firstChild,p=false;while(r){if(r.nodeType===xtdom.ELEMENT_NODE&&r.firstChild){p=true;break}r=r.nextSibling}return p};var e=function(r,q){var p;if(r==="normal"){p=$.trim(q).replace(/((\r\n|\n|\r)+)/gm,"$2$2").replace(/(\r\n|\n|\r)\s+(\r\n|\n|\r)/gm,"$1$2")}else{if(r==="enhanced"){p=$.trim(q).replace(/((\r\n|\n|\r){2,})/gm,"$2$2").replace(/(\r\n|\n|\r)\s+(\r\n|\n|\r)/gm,"$1$2")}else{p=$.trim(q)}}return p};var o={subscribe:function(p){var r=this;var q=function(s){if(!r.isEditing()){r.startEditing(s)}xtdom.stopPropagation(s);xtdom.preventDefault(s)};if(this.isEditable){xtdom.addEventListener(p,"focus",q,true);xtdom.addEventListener(p,"mouseup",function(s){xtdom.stopPropagation(s);xtdom.preventDefault(s)},true)}},isFocusable:function(){return(this.isEditable&&((!this._editor.isOptional())||this._editor.isSet()))},isEditing:function(){return this._isEditing},doKeyDown:function(p){},doKeyUp:function(p){},focus:function(){this._editor.getHandle().focus();this.startEditing()},unfocus:function(){this.stopEditing()},cancelEditing:function(){this._editor.getHandle().value=this._legacy;this.stopEditing(true,false)},clear:function(){this._editor.getHandle().value=this.defaultData},update:function(p){if(p===this._legacy){return}if(p.search(/\S/)===-1||(p===this._defaultData)){this._editor.clear(true)}else{this._editor.setModified(p!==this.defaultData);this._editor.set(true)}}};var h=function(v,p,q){var u=v.getHandle(),s="number"!==p?p:"text",r;this._editor=v;this.isEditable=!v.getParam("noedit");this.defaultData=q||"";xtdom.setAttribute(u,"type",s);if(r=v.getParam("size")){xtdom.setAttribute(u,"size",r)}u.value=this.defaultData};h.prototype={awake:function(){var p=this._editor.getHandle();var q=this;this.subscribe(p);if(this.isEditable){xtdom.addEventListener(p,"blur",function(r){if(q.isEditing()){q.stopEditing(false,true)}},true)}},load:function(w,u){var r,v,s;if(w!==-1){s=this._editor.getParam("multilines");if((s==="normal")||(s==="enhanced")){if(i(w[0])){var t=w[0].firstChild,q,p="";while(t){if(t.nodeType===xtdom.ELEMENT_NODE&&t.firstChild){if("Text"===t.nodeName){p=p+t.firstChild.nodeValue+"\n\n"}else{if("Block"===t.nodeName){q=t.firstChild;while(q){if(q.nodeType===xtdom.ELEMENT_NODE&&q.firstChild){p=p+q.firstChild.nodeValue+"\n"}q=q.nextSibling}p=p+"\n"}}}t=t.nextSibling}r=p}else{r=e(s,u.getDataFor(w))}}else{r=u.getDataFor(w)}v=this._editor.getDefaultData();this._editor.getHandle().value=r||v||"";this._editor.setModified(r!==v);this._editor.set(false)}else{this._editor.clear(false)}},save:function(q){var u=$.trim(this._editor.getHandle().value),t,r;var s=function(w,v){if(v.length>0){q.openTag("Text");q.write(v);q.closeTag("Text")}};var p=function(x,w){var v=x.charCodeAt(1);if((v===10)||(v===13)){c(t,q);t=[]}if(w.length>0){t.push(w)}};if(u){multi=this._editor.getParam("multilines");if(multi){r=new RegExp("[\n\r]{0,}(.*)","g");if("normal"===multi){u.replace(r,s)}else{t=[];u.replace(r,p);c(t,q)}}else{if("number"===this._editor.getParam("type")){q.write(u.replace(",","."))}else{q.write(u)}}}},startEditing:function(q){var p,r=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){p=this._editor.getHandle();this._legacy=p.value;this._isEditing=true;this.kbdHandlers=r.register(this,p);r.grab(this,this._editor);if(this._editor.getParam("multilines")){r.enableRC(true)}if(!this._editor.isModified()){xtdom.focusAndSelect(p)}}},stopEditing:function(p,t){var q,s,r;if(this._isEditing){q=this._editor.getHandle();s=xtiger.session(this._editor.getDocument()).load("keyboard");this._isEditing=false;s.unregister(this,this.kbdHandlers,q);s.release(this,this._editor);if("normal"===this._editor.getParam("multilines")){s.disableRC()}if(!p){r=this._editor.getParam("multilines");q.value=e(r,q.value);this._editor.update(q.value)}if((!t)&&(q.blur)){q.blur()}}}};var k=function(r,p,q){xtdom.setAttribute(r.getHandle(),"type","text");this._editor=r;this.isEditable=!r.getParam("noedit");this.defaultData=q||"";this.dpDone=false};k.prototype={lazyInit:function(q){var p,r=this;if($.datepicker){$(q).on("keydown",function(s){if(s.keyCode===$.ui.keyCode.ESCAPE){r.onEscape()}xtdom.stopPropagation(s)});this.jhandle=$(q).datepicker({onClose:function(){r.onClose()}})}else{alert('datepicker jQuery plugin needed for "date" input field !')}this.dpDone=true},awake:function(){var p=this._editor.getHandle();this.subscribe(p);if(this.defaultData==="today"){p.value=this.defaultData=$.datepicker?l(this._editor):new Date()}else{p.value=xtiger.util.date.convertDate(this._editor,this.defaultData,"date_format","date_region")}this.model=p.value;if(!this._editor.getParam("size")){xtdom.setAttribute(p,"size",8)}},onEscape:function(p){this.escape=true},onClose:function(){this.stopEditing(this.escape);this.escape=false},startEditing:function(s){var q,p,t,r;xtiger.util.date.setRegion(this._editor.getParam("date_region"));if(!this.dpDone){r=this._editor.getHandle();this.lazyInit(r);if(this.jhandle){q=this._editor.getParam("minDate");p=this._editor.getParam("maxDate");t=this._editor.getParam("beforeShow");if(q){q=(q==="today")?l(this._editor):xtiger.util.date.convertDate(this._editor,q,"date_format","date_region");this.jhandle.datepicker("option","minDate",q)}if(p){p=(p==="today")?l(this._editor):xtiger.util.date.convertDate(this._editor,p,"date_format","date_region");this.jhandle.datepicker("option","maxDate",p)}if(t){this.jhandle.datepicker("option","beforeShow",t)}$(r).datepicker("show")}}},stopEditing:function(p){var q=this._editor.getHandle();val=q.value;if(val.search(/\S/)===-1){val=""}if(val&&((val.length!==10)||p)){q.value=this.model}else{this._editor.update(val);this.model=q.value}},load:function(t,r){var q,s,p=this._editor.getHandle();if(t!==-1){q=r.getDataFor(t);q=q?($.datepicker?xtiger.util.date.convertDate(this._editor,q,"date_format","date_region"):q):null;s=this.defaultData;p.value=q||s||"";this._editor.setModified(q!==s);this._editor.set(false)}else{this.clear(false)}this.model=p.value},save:function(p){var q=this._editor.getHandle().value;if(q){q=$.datepicker?xtiger.util.date.convertDate(this._editor,q,"date_region","date_format"):q;p.write(q)}}};var g=function(u,p,s){var t=u.getHandle(),r=u.getParam("name"),q=u.getParam("cardinality"),v=u.getParam("checked");this._editor=u;this._type=p;if(r||(p==="radio")){if(q){s=d(r||"void",q).toString()}r=(r||"").concat(s||"");xtdom.setAttribute(t,"name",r)}if(v){if(v===u.getParam("value")){t.checked=true}else{j(r,v)}}else{if(b(r,u.getParam("value"))){t.checked=true}}if(u.getParam("noedit")==="true"){xtdom.addClassName(t,"axel-input-unset")}};g.prototype={awake:function(){var p=this._editor.getHandle();var q=this;xtdom.addEventListener(p,"click",function(r){if(q._editor.getHandle().checked){q._editor.update(q._editor.getParam("value"))}else{q._editor.update("")}},true)},isFocusable:function(){return true},load:function(v,u){var t,q=this._editor.getHandle(),p=false,s=this._editor.getParam("value"),r;if(-1!==v){t=u.getDataFor(v);p=(t===s);if(!p){name=this._editor.getParam("name");p=b(name,s);j(name,t)}if(p){if(!q.checked){q.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(q,"axel-input-unset")}}}else{this._editor.clear(false)}}else{r=this._editor.getParam("checked");if(r){if(r===s){p=true}else{name=this._editor.getParam("name");j(name,r)}}else{name=this._editor.getParam("name");p=b(name,s)}if(p){if(!q.checked){q.checked=true;this._editor.set(false);if(this._editor.getParam("noedit")==="true"){xtdom.removeClassName(q,"axel-input-unset")}}}else{this._editor.clear(false)}}},save:function(p){var q=this._editor;if(q.getHandle().checked&&(q.getParam("noxml")!=="true")){p.write(this._editor.getParam("value"))}else{p.discardNodeIfEmpty()}},update:function(p){},clear:function(){var p=this._editor.getHandle();if(this._editor.getParam("noedit")==="true"){xtdom.addClassName(p,"axel-input-unset")}p.checked=false},focus:function(){this._editor.getHandle().focus()},unfocus:function(){}};var f={onGenerate:function(u,s,r){var t=s.getAttribute("param"),q=(!t||(t.indexOf("type=textarea")===-1))?"input":"textarea",p=xtdom.createElement(r,q);if(t){if(t.indexOf("type=radio")!==-1){xtdom.setAttribute(p,"type","radio")}else{if(t.indexOf("type=checkbox")!==-1){xtdom.setAttribute(p,"type","checkbox")}}}if(this.getParam("noedit")==="true"){p.disabled=true}u.appendChild(p);return p},onInit:function(t,p,r){var q,s;q=this.getParam("type");if((q==="text")||(q==="number")||(q==="password")||(q==="textarea")){this._delegate=new h(this,q,t)}else{if((q==="radio")||(q==="checkbox")){this._delegate=new g(this,q,r?r.getClockCount():undefined)}else{if(q==="date"){this._delegate=new k(this,q,t)}else{xtdom.addClassName(this._handle,"axel-generator-error");xtdom.setAttribute(this._handle,"readonly","1");xtdom.setAttribute(this._handle,"value",'ERROR: type "'+q+'" not recognized by plugin "input"');alert('Form generation failed : fatal error in "input" plugin declaration')}}}if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){this._delegate.awake()},onLoad:function(q,p){this._delegate.load(q,p)},onSave:function(p){if(($(this.getHandle()).attr("disabled")==="disabled")||(this.isOptional()&&!this.isSet())){p.discardNodeIfEmpty()}else{this._delegate.save(p)}},api:{isFocusable:function(){return this._delegate.isFocusable()},focus:function(){if(this._delegate.focus){this._delegate.focus()}},unfocus:function(){if(this._delegate.focus){this._delegate.unfocus()}}},methods:{update:function(p){this._delegate.update(p)},clear:function(p){this._delegate.clear();this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(p)}},set:function(p){if(p){if(!this.getParam("noedit")){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle())}xtdom.removeClassName(this._handle,"axel-repeat-unset")}if(!this._isOptionSet){this._isOptionSet=true;if(this._isOptional){this._handle.disabled=false;this._optCheckBox.checked=true}}},unset:function(p){if(this._isOptionSet){this._isOptionSet=false;if(this._isOptional){this._handle.disabled=true;this._optCheckBox.checked=false}}}}};m.extend(h.prototype,o);m.extend(k.prototype,o);m.plugin.register("input",{filterable:true,optional:true},{type:"text",date_region:"fr",date_format:"ISO_8601"},f)}($axel));(function(a){var b={onGenerate:function(f,e,c){var d=xtdom.createElement(c,"div");xtdom.addClassName(d,"af-html");f.appendChild(d);return d},onInit:function(e,c,d){if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){},onLoad:function(f,e){var c,d;if(e.isEmpty(f)){$(this.getHandle()).html("")}else{d=$(this.getHandle());d.html("");for(c=1;c<f.length;c++){d.append(f[c])}}},onSave:function(c){c.write("HTML BLOB")},api:{},methods:{}};a.plugin.register("html",{filterable:false,optional:false},{key:"value"},b)}($axel));(function(h){var f={dropdownAutoWidth:"bool",minimumResultsForSearch:"int",closeOnSelect:"bool",width:"str",maximumSelectionSize:"int",minimumInputLength:"int"};function b(l){var k,m,p,j="",o="ÀÁÂÃÄÅÒÓÔÕÕÖØÈÉÊËÇÐÌÍÎÏÙÚÛÜÑŠŸŽ",n="AAAAAAOOOOOOOEEEECDIIIIUUUUNSYZ";for(k=0;k<l.length;k++){m=l.charAt(k).toUpperCase();p=o.indexOf(m);j+=(p>=0)?n.charAt(p):m}return j}function e(o,n,l,j,m){var k=n.length;l.push(j(o.substring(0,m)));l.push("<span class='select2-match'>");l.push(j(o.substring(m,m+k)));l.push("</span>");l.push(j(o.substring(m+k,o.length)))}function d(m,j){var n,l,k;if($.isArray(m)&&m[0]){n=m[0].text||""}else{n=(m&&m.text)?m.text:""}l=n.indexOf("::");k=(l!==-1)?n.substr(0,l):n;return k}function g(j,l,r,q,m){var t=(j&&j.text)?j.text:"",o=t.indexOf("::"),k=m||' - <span class="select2-complement">',n="</span>",s=b(r.term),p,u;if(t){u=[];if(o!==-1){if(r.term.length>0){p=b(t).indexOf(s);if(p<o){e(t.substr(0,o),s,u,q,p);u.push(k+q(t.substr(o+2))+n)}else{if(p>o+1){u.push(t.substr(0,o));u.push(k);e(t.substr(o+2),s,u,q,p-o-2);u.push(n)}else{return q(t.substr(0,o))+k+q(t.substr(o+2))+n}}}else{return q(t.substr(0,o))+k+q(t.substr(o+2))+n}}else{if(r.term.length>0){p=b(t).indexOf(s);if(p>=0){e(t,s,u,q,p)}else{return t}}else{return t}}return u.join("")}}function c(k,m,l){var j;if(l){j=l.data("key");if(!j){j=b(m);l.data("key",j)}}else{j=b(m)}return j.indexOf(b(k))>=0}function a(j,k){var l=k-j.length;return xtiger.util.getLocaleString("hintMinInputSize",{n:l})}var i={onGenerate:function(l,k,j){var m;if(this.getParam("select2_tags")==="yes"){m=xtdom.createElement(j,"input")}else{m=this.__select2__onGenerate(l,k,j)}l.appendChild(m);$(m).wrap('<span class="axel-guard"/>');return m},onAwake:function(){var p=this,o=this.getDefaultData(),m=this.getParam("placeholder"),q=this.getParam("select2_complement"),t=q?' - <span class="'+q+'">':undefined,r=q?function(k,w,u,v){return g(k,w,u,v,t)}:g,l={myDoc:this.getDocument(),formatResult:r,formatSelection:d,matcher:c,formatInputTooShort:a},n,s,j;for(n in f){s=this.getParam("select2_"+n);if(s){if(f[n]==="bool"){j=s==="true"?true:false}else{if(f[n]==="int"){j=parseInt(s,10)}else{j=s}}l[n]=j}}if(this.getParam("select2_tags")==="yes"){l.multiple=false;l.tags=this.getParam("i18n");delete l.minimumResultsForSearch}else{if(m||(!o)){m=m||"";if(this.getParam("multiple")!=="yes"){$(this._handle).prepend("<option></option>")}if(!o){this._param.values.splice(0,0,m);if(this._param.i18n!==this._param.values){this._param.i18n.splice(0,0,m)}}l.allowClear=true;l.placeholder=m}if(this.getParam("multiple")!=="yes"){if(this.getParam("typeahead")!=="yes"){l.minimumResultsForSearch=-1}}}this._setData(o);$(this._handle).select2(l).change(function(k,u){if(!(u&&u.synthetic)){p.update($(this).val())}});$(this._handle).prev(".select2-container").get(0).xttNoShallowClone=true},onLoad:function(k,j){this.__select2__onLoad(k,j);$(this._handle).trigger("change",{synthetic:true})},api:{update:function(j){var k=this;this.__select2__update(j);setTimeout(function(){$(k._handle).select2("focus")},50)},focus:function(){$(this._handle).select2("focus")}},methods:{_setData:function(l,m){var j=l,k;if(this.getParam("select2_tags")){k=l.indexOf("::");if(k!==-1){j=l.substr(0,k)}}this.__select2___setData(j,m)}}};h.filter.register("select2",{chain:["update","onGenerate","onLoad","_setData"]},{select2_dropdownAutoWidth:"false",select2_minimumResultsForSearch:"7",select2_closeOnSelect:"false",select2_width:"element",select2_maximumSelectionSize:"-1",select2_minimumInputLength:undefined},i);h.filter.applyTo({select2:"choice"})}($axel));(function(a){var d={onLoad:function c(l,k){var i,j,g,f,e=this.getParam("xvalue");if(k.isEmpty(l)||!e){this.__list__onLoad(l,k)}else{j=[];g=k.getVectorFor(e,l);while(g!==-1){f=k.getDataFor(g);if(f){j.push(f)}g=k.getVectorFor(e,l)}j=j.join(", ");i=this.getHandle();fallback=this.getDefaultData()||"";this.getHandle().value=j||fallback||"";this.setModified(j!==fallback);this.set(false)}},onSave:function b(f){var e,j,g,h=$.trim(this.getHandle().value);if((!this.isOptional())||this.isSet()){if(h){e=this.getParam("xvalue");if(e){j=h.split(/\s*,\s*/);for(g=0;g<j.length;g++){if(j[g]!==""){f.openTag(e);f.write(j[g]);f.closeTag(e)}}}else{this.__list__onSave(f)}}}else{f.discardNodeIfEmpty()}},methods:{update:function(e){var f=this.getHandle().value.split(/\s*,\s*/).join(", ");if("true"===this.getParam("list_uppercase")){f=f.toUpperCase()}this.getHandle().value=f;fallback=this.getDefaultData()||"";this.setModified(f!==fallback)}}};a.filter.register("list",{chain:["onLoad","onSave"]},null,d);a.filter.applyTo({list:["input"]})}($axel));(function(a){var b={onInstall:function(c){this.avoidstr="data-avoid-"+this.getVariable();this.editor=a(c);c.bind("axel-update",$.proxy(this.updateConditionals,this));this.updateConditionals();$(document).bind("axel-content-ready",$.proxy(this,"updateConditionals"))},methods:{updateConditionals:function(f,e){var d,h;var g=this.editor.text();var c=$("body ["+this.avoidstr+"]",this.getDocument());d=(g!="")?c.not("["+this.avoidstr+'*="'+g+'"]'):c.not("["+this.avoidstr+'=""]');h=(g!="")?c.filter("["+this.avoidstr+'*="'+g+'"]'):c.filter("["+this.avoidstr+'=""]');d.find("input").removeAttr("disabled");d.css("color","inherit");h.find("input").attr("disabled","disabled");h.css("color","lightgray")}}};a.binding.register("condition",null,null,b)}($axel));(function(a){function c(f,d,h){try{return d?xtiger.util.date.convertDate(f,d,"date_format","date_region"):h}catch(g){return h}}var b={onInstall:function(g){var e=this.getVariable(),f=$("[data-min-date="+e+"]",g.get(0)),d=$("[data-max-date="+e+"]",g.get(0));this.min=a(f.get(0),true);this.max=a(d.get(0),true);this.min.configure("beforeShow",$.proxy(this.beforeShowMinDate,this));this.max.configure("beforeShow",$.proxy(this.beforeShowMaxDate,this))},methods:{beforeShowMinDate:function(d,e){return{maxDate:c(this.max.get(0),this.max.text(),null)}},beforeShowMaxDate:function(d,e){return{minDate:c(this.min.get(0),this.min.text(),null)}}}};a.binding.register("interval",null,null,b)}($axel));(function(a){var b={onInstall:function(d){var e=d.attr("data-pattern"),c,f;this.re=new RegExp(this.getParam("regexp")||"");this.editor=a(d);this.spec=d;d.bind("axel-update",$.proxy(this.checkRegexp,this));if(e){d.find("input").attr("pattern",e)}a.binding.setValidation(this.editor.get(0),$.proxy(this.validate,this))},methods:{checkRegexp:function(){var g=this.re.test(this.editor.text()),f,d,i=this.getDocument(),c=this.spec.get(0),e=this.spec.attr("data-valid-class"),h=this.spec.attr("data-invalid-class");if(e||h){if(!this.errScope){d=$("body "+this.spec.attr("data-label-selector"),i)}else{f=$(c,i).closest(this.errScope);d=$(this.spec.attr("data-label-selector"),f.get(0))}if(e){g?d.addClass(e):d.removeClass(e)}if(h){g?d.removeClass(h):d.addClass(h)}}return this.toggleError(g,this.editor.get(0).getHandle(true))},validate:function(){var c=this.checkRegexp();return(this.spec.attr("data-validation")==="off")||c}}};a.binding.register("regexp",{error:true},{regexp:a.binding.REQUIRED},b)}($axel));(function(b){var a={onInstall:function(c){this.editors=b(c);this.handle=c.get(0);if(this.handle.xttPrimitiveEditor){xtiger.cross.log("error",'Failed attempt to attach a "required" binding directly onto a primitive editor')}else{this.handle.xttPrimitiveEditor=this}},methods:{isModified:function(){var c=(this.editors.text()!=="");return c},isFocusable:function(){var c=this.editors.get(1);return(c&&(c!==this))?c.isFocusable():false},focus:function(){var c=this.editors.get(0);if(c){this.editors.get(0).focus()}},unfocus:function(){},can:function(c){return false},getHandle:function(){return this.handle},onInit:function(e,c,d){},onAwake:function(){},load:function(d,c){},save:function(c){}}};b.binding.register("required",{error:true},{required:"true"},a)}($axel));(function(a){var b={onInstall:function(c){this.host=c;this.editors=a(c);$('[data-select="'+this.getVariable()+'"]',this.getDocument()).bind("click",$.proxy(this,"execute"))},methods:{execute:function(){this.editors.apply(function(c){if(!c.disabled){c.checked=true}},true);$(this.host).triggerHandler("axel-select-all",[this])}}};a.binding.register("select",null,null,b)}($axel));(function(){function a(c,d,e){var b=$(d);this.doc=e;this.key=c;this.spec=b;if(!/\btransform\b/.test(b.attr("data-command"))){this.transform();this.implicit=true}else{this.implicit=false}this.defaultTpl=this.spec.attr("data-template");this.defaultData=this.spec.attr("data-src")||"";this.ready=false}a.prototype={getDefaultTemplate:function(){return this.defaultTpl},getDefaultSrc:function(){return this.defaultData},attr:function(b){if(arguments.length>1){return this.spec.attr(b,arguments[1])}else{return this.spec.attr(b)}},transform:function(c,b){var e,h,d,f=c||this.spec.attr("data-template"),g=b||this.spec.attr("data-src");if((f===this.spec.attr("data-template"))&&this.ready){if(b){this.spec.attr("data-src",b)}this.reset()}else{if(f){if(f!=="#"){e=f.substring(f.lastIndexOf("/")+1);if(e.indexOf("?")!==-1){e=e.substring(0,e.indexOf("?"))}}d={bundlesPath:$axel.command.defaults.bundlesPath,enableTabGroupNavigation:true};h=(f==="#")?$axel(this.spec).transform(d):$axel(this.spec).transform($axel.resolveUrl(f,this.spec.get(0)),d);if(g){h.load($axel.resolveUrl(g,this.spec.get(0)));this.spec.attr("data-src",g)}if(this.spec.attr("data-cancel")){$(window).bind("unload",$.proxy(this,"reportCancel"))}if(h.transformed()){if(!this.implicit){$axel.binding.install(this.doc,this.spec.get(0),this.spec.get(0));$axel.command.install(this.doc,this.spec.get(0).firstChild,this.spec.get(0).lastChild)}this.spec.attr("data-template",f);this.spec.addClass("edition").addClass(e);this.ready=true}else{this.ready=false}}else{$axel.error('Missing data-template attribute to generate the editor "'+this.key+'"')}}},reset:function(c){var b;if(c&&this.defaultTpl&&(this.defaultTpl!==this.spec.attr("data-template"))){this.attr("data-src",this.defaultData);this.transform($axel.resolveUrl(this.defaultTpl,this.spec.get(0)))}else{b=this.spec.attr("data-src");if(b){$axel(this.spec).load($axel.resolveUrl(b,this.spec.get(0)))}else{$axel(this.spec).load("<Reset/>")}$('*[class*="af-invalid"]',this.spec.get(0)).removeClass("af-invalid");$('*[class*="af-required"]',this.spec.get(0)).removeClass("af-required")}},reload:function(){var b=this.spec.attr("data-src");$('*[class*="af-invalid"]',this.spec.get(0)).removeClass("af-invalid");$('*[class*="af-required"]',this.spec.get(0)).removeClass("af-required");if(b){$axel(this.spec).load($axel.resolveUrl(b,this.spec.get(0)))}},load:function(b){var c=$axel(this.spec);$('*[class*="af-invalid"]',this.spec.get(0)).removeClass("af-invalid");$('*[class*="af-required"]',this.spec.get(0)).removeClass("af-required");c.load("<Reset/>");if(b){c.load($axel.resolveUrl(b,this.spec.get(0)))}this.attr("data-src",b)},trigger:function(c,d,b){this.spec.triggerHandler(c,[this,d,b])},serializeData:function(){return $axel(this.spec).xml()},reportCancel:function(b){if(!this.hasBeenSaved){$.ajax({url:this.spec.attr("data-cancel"),data:{transaction:this.spec.attr("data-transaction")},type:"GET",async:false})}}};$axel.command.register("transform",a,{check:false})}());(function(){function a(b,c){this.key=b;$(c).bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(d){var b,c=$axel.command.getEditor(this.key);if(c){c.reset();b=c.attr("data-validation-output");if(b){$("#"+b).removeClass("af-validation-failed")}}}};$axel.command.register("reset",a,{check:true})}());(function(){function a(b,c,d){this.doc=d||document;this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype=(function(){function f(i,k){var j;if(/all|swap|append|prepend/.test(i)){j=$axel.oppidum.unmarshalPayload(k);fnode=$("#"+this.spec.attr("data-replace-target"));if(fnode.length>0){if(i.indexOf("all")!==-1){fnode.replaceWith(j)}else{if(i.indexOf("swap")!==-1){this.swap=$(j);fnode.after(this.swap);fnode.hide();this.fragment=fnode;$('button[data-command="continue"]',this.swap).bind("click",$.proxy(c,this));$('button[data-command="reset"]',this.swap).bind("click",$.proxy(g,this))}else{if(i.indexOf("append")!==-1){fnode.append(j)}else{if(i.indexOf("prepend")!==-1){fnode.prepend(j)}}}}}else{xtiger.cross.log("error",'missing "data-replace-target" attribute to report "save" command success')}}}function c(){this.swap.remove();this.fragment.show()}function g(){var i=$axel.command.getEditor(this.key);if(i){i.reset();this.swap.remove();this.fragment.show()}else{$axel.error(xtiger.util.getLocaleString("editorNotFound"))}}function e(k,l,q,p){var o,i,m,n,j;if((q.status===202)&&p){j=$axel.oppidum.getCommand(q);n=confirm($axel.oppidum.decodeMessage(j));if(p.url.indexOf("?")!==-1){m=p.url+"&_confirmed=1"}else{m=p.url+"?_confirmed=1"}if(n){$.ajax({url:m,type:p.method,data:p.payload,cache:false,timeout:50000,dataType:"xml",contentType:"application/xml; charset=UTF-8",success:$.proxy(e,this),error:$.proxy(d,this)});return}else{$axel.command.getEditor(this.key).trigger("axel-save-cancel",this,q)}}else{if((q.status===201)||(q.status===200)){j=$axel.oppidum.getCommand(q);if($axel.oppidum.filterRedirection(j)){$axel.oppidum.handleMessage(j);o=this.spec.attr("data-replace-type")||"all";f.call(this,o,q);$axel.command.getEditor(this.key).trigger("axel-save-done",this,q);if(o.indexOf("event")!==-1){m=this.spec.attr("data-event-target");if(m){m=$axel.command.getEditor(m);if(m){m.trigger("axel-save-done",this,q)}}}}}else{$axel.error(xtiger.util.getLocaleString("errServerResponse",{xhr:q}));$axel.command.getEditor(this.key).trigger("axel-save-error",this,q)}}h(this);if(j){$axel.oppidum.handleForward(j)}}function d(m,j,k){var l,i=this.spec.attr("data-save-flags");if((!i)||i.indexOf("silentErrors")===-1){l=$axel.oppidum.parseError(m,j,k);$axel.error(l)}else{this.spec.trigger("axel-network-error",{xhr:m,status:j,e:k})}$axel.command.getEditor(this.key).trigger("axel-save-error",this,m);h(this)}function b(j){var i=j.spec.attr("data-save-flags");if(i&&i.indexOf("disableOnSave")!=-1){j.spec.attr("disabled","disable")}j.spec.addClass("axel-save-running")}function h(j){var i=j.spec.attr("data-save-flags");if(i&&i.indexOf("disableOnSave")!=-1){j.spec.removeAttr("disabled")}j.spec.removeClass("axel-save-running")}return{execute:function(k){var j,u,m,n,p,o,q,s=this,i=true,r=$axel.command.getEditor(this.key),l=this.spec.attr("data-save-confirm"),t=this.spec.attr("data-type");if(r){if(!l||confirm(l)){url=this.spec.attr("data-src")||r.attr("data-src")||".";if(url){if(r.attr("data-validation-output")||this.spec.attr("data-validation-output")){p=$axel(r.spec.get(0));i=$axel.binding.validate(p,r.attr("data-validation-output")||this.spec.attr("data-validation-output"),this.doc,r.attr("data-validation-label")||this.spec.attr("data-validation-label"),r.attr("data-no-validation-inside")||this.spec.attr("data-no-validation-inside"))}if(i){n=r.serializeData();if(n){j=r.attr("data-method")||this.spec.attr("data-method")||"post";m=r.attr("data-transaction")||this.spec.attr("data-transaction");if(m){url=url+"?transaction="+m}url=$axel.resolveUrl(url,this.spec.get(0));b(this);$axel.command.getEditor(this.key).trigger("axel-save",this);q={url:url,payload:n,method:j};o=function(w,x,v){e.call(s,w,x,v,q)};$.ajax({url:url,type:j,data:n,dataType:t||"xml",cache:false,timeout:50000,contentType:"application/xml; charset=UTF-8",success:o,error:$.proxy(d,this)});r.hasBeenSaved=true}else{$axel.error(xtiger.util.getLocaleString("editorEmpty"))}}}else{$axel.error(xtiger.util.getLocaleString("noTargetURL"))}}}else{$axel.error(xtiger.util.getLocaleString("editorNotFound"))}}}}());$axel.command.register("save",a,{check:false})}());(function(){function a(c,d){var b=$(d);this.key=c;this.formid=b.attr("data-form");if(this.formid&&($("form#"+this.formid).length>0)){d.disabled=false;b.bind("click",$.proxy(this,"execute"))}else{d.disabled=true;$axel.error('Missing or invalid data-form attribute in submit command ("'+this.formid+'")')}}a.prototype={execute:function(){var c=$("#"+this.formid),e=$("#"+this.formid+' > input[name="data"]'),b=$axel.command.getEditor(this.key);if(b&&(c.length>0)&&(e.length>0)){e.val(b.serializeData());c.submit()}else{$axel.error("Missing editor or malformed form element to submit data")}}};$axel.command.register("submit",a,{check:true})}());(function(){function a(b,c){this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(b){$axel.command.getEditor(this.key).trigger(this.spec.attr("data-trigger-event"),this)}};$axel.command.register("trigger",a,{check:false})}());(function(){function a(b,c){this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"));$("#"+b).bind("axel-cancel-edit",$.proxy(this,"dismiss"));$("#"+b).bind("axel-save-done",$.proxy(this,"saved"))}a.prototype={execute:function(e){var c,d,g,b=$axel.command.getEditor(this.key),f=this.spec.attr("data-edit-action");if(f){if(f==="update"){b.attr("data-src",this.spec.attr("data-src"))}else{if(f==="create"){b.attr("data-src","")}}}if(!this.done||!b.getDefaultTemplate()){d=this.spec.attr("data-with-template");b.transform(d?$axel.resolveUrl(d,this.spec.get(0)):undefined)}else{if(this.cleanOnShow){b.reset();this.cleanOnShow=false}}d=this.spec.attr("data-add-key");if(d){d="data-when-"+d;g=$("#"+this.spec.attr("data-title-scope")).find("["+d+"]");g.text(g.attr(d))}if($axel("#"+this.key).transformed()){this.done=true;c=this.spec.attr("data-target-modal");if(f==="create"){b.attr("data-src",this.spec.attr("data-src"))}if(c){$("#"+c).modal("show").one("hidden",$.proxy(this,"hidden"));this.spec.get(0).disabled=true}else{$("#"+this.spec.attr("data-target-ui")).show();this.spec.hide()}}},dismiss:function(c){var b;b=this.spec.attr("data-target-modal");if(b){$("#"+b).modal("hide")}else{$("#"+this.spec.attr("data-target-ui")).hide();this.spec.show()}},saved:function(b){this.dismiss();this.cleanOnShow=true},hidden:function(){this.spec.get(0).disabled=false}};$axel.command.register("add",a,{check:true})}());(function(a){a.addLocale("en",{errFormRequired:function(b){return"You must fill the following fields : "+b.fields},errFormInvalid:function(b){return"You must correct the following fields : "+b.fields},hintMinInputSize:function(b){return"Type at least "+b.n+" letter"+(b.n===1?"":"s")},errServerResponse:function(b){return"Unexpected response from server ("+b.xhr?b.xhr.status:"undefined). The action may have failed"},errServerTimeOut:"Action aborted: server is taking too much time to answer. You should reload the page to check if the action has been executed anyway",msgRedirect:"You are going to be redirected",editorEmpty:"The document contains no data",noTargetURL:"The command does not know where to send the data",editorNotFound:"There is no editor associated with this command"})}($axel));(function(a){a.addLocale("fr",{errFormRequired:function(b){return"Vous devez remplir les champs suivants : "+b.fields},errFormInvalid:function(b){return"Vous devez corriger les champs suivants : "+b.fields},hintMinInputSize:function(b){return"Entrez au moins "+b.n+" caractère"+(b.n===1?"":"s")},errServerResponse:function(b){return"Mauvaise réponse du serveur ("+b.xhr?b.xhr.status:"undefined). L'action a peut-être échoué"},errServerTimeOut:"Action annulée, délai de réponse dépassé. Rechargez la page pour vérifier si votre action a été prise en compte.",msgRedirect:"Vous allez être redirigé",editorEmpty:"Le document est vide",noTargetURL:"La commande ne sait pas où envoyer les données",editorNotFound:"Il n'y a pas d'éditeur associé avec cette commande"})}($axel));